<!doctype html>
<html>
<head>
    <% include ./head %>
</head>
<% include ./header %>
<style>
/*ul {
	display:inline-block;
}*/

/*li {
	display:inline-block;
	list-style-type: none;
	margin-bottom:10px;
}*/
</style>
	<div class="page-header text-center">
		<button class="btn pull-right btn-success" id="create"> Create Audition</button>
		<h2>Add an Audition</h2>
	</div>

	<div class="container">
		<form class="form-horizontal" id="form">

			<div class="form-group">
				<label class="control-label col-sm-2" for="show">Show: </label>
				<div class="col-sm-8">
					<select class="selectpicker" title="Choose a show">
					<% shows.forEach(function(show) {%>
  						<option name='<%=show.title%>' data-id='<%=show.id%>'><%= show.title %></option>
  					<% }); %>
					</select>
					<div id="showValidation"></div>
				</div>
			</div>

			<div class="form-group">
				<label class="control-label col-sm-2" for="venue">Audition Venue: </label>
				<div class="col-sm-8">
					<input type="text" class="form-control" id="venue" name="venue">
					<div id="venueValidation"></div>
				</div>
			</div>

			<div class="form-group">
				<label class="control-label col-sm-2" for="contact">Contact: </label>
				<div class="col-sm-8">
					<input type="text" class="form-control" id="email" placeholder="Email">
					<div id="emailValidation"></div>
					<br>
					<input type="text" class="form-control" id="phoneNumber" placeholder="Phone Number">
					<div id="phoneNumberValidation"></div>
				</div>
			</div>			

			<div class="form-group">
				<label class="control-label col-sm-2" for="venue">Notes: </label>
				<div class="col-sm-8">
					<textarea rows="8" cols="80" id="notes"></textarea>
				</div>
			</div>

			<!-- https://github.com/Eonasdan/bootstrap-datetimepicker -->
			<div class="form-group">
				<label class="control-label col-sm-2" for="date">When: </label>
				<div class="col-sm-8" id="dateCol">
					<div style="overflow:hidden; display:block;">
				        <div class="row">
				            <div class="col-md-8">
			    	            <div id="datetimepicker12"></div>
			        	    </div>
				        </div>
					</div>
					<button class="btn btn-primary" id="addAudition">Add audition time</button>
					<div id='dateValidation'></div>
				</div>			
			</div>
			
			<br>
			<br>
			<br>

 			<table class="table table-hover" id="auditionsTable">
				<thead>
					<tr>
						<th>Select</th>
						<th>Date</th>
						<th>Time</th>
					</tr>
				</thead>
				<tbody id="auditionsTableBody">
				</tbody>
			</table>
			<button class="btn btn-primary" id="deleteAudition">Delete audition time</button>

		</form>
	</div>

        </div>
        <!-- /#page-content-wrapper -->

    </div>
    <!-- /#wrapper -->

<script>

$(document).ready(function() {

	var minDateValue = moment();
	var maxDateValue = moment().add(1, 'year')

    $('#datetimepicker12').datetimepicker({
        inline: true,
        sideBySide: true,
        minDate: minDateValue,
        maxDate: maxDateValue
    });	

	$("#addAudition").click(function(e) {
		e.preventDefault();
		var date = $("#datetimepicker12").data('DateTimePicker').date();

		// Date
		var day = date.date();
		var month = moment().month(date.month()).format('MMM');
		var year = date.year();

		// Time
		var suffix = date.hour() >= 12 ? "PM":"AM"; 
		var hours = (date.hour() + 11) % 12 + 1;
		var minute = (date.minute() < 10? '0':'') + date.minute();

        var markup = $("<tr><td><input type='checkbox' name='record'></td><td>" + month + " " + day + " " + year + "</td><td>" + hours + ":" + minute + " " + suffix + "</td></tr>");
        markup.data("date", date);
        $("#auditionsTableBody").append(markup);
    });

    $("#deleteAudition").click(function(e){
    	e.preventDefault();
        $("#auditionsTableBody").find('input[name="record"]').each(function(){
          	if($(this).is(":checked")){
                $(this).parents("tr").remove();
            }
        });
    });

    $("#create").click(function(e) {
    	e.preventDefault();

    	var showVal = $(".selectpicker").val();
    	var venueVal = $("#venue").val();
    	var email = $("#email").val();
    	var phoneNumber = $("#phoneNumber").val();
    	var dateCount = document.getElementById("auditionsTable").rows.length;

    	// Form Validation
    	if (!showVal || !venueVal || !email || !phoneNumber || dateCount <= 1) {
    		if (!showVal) {
    			$("#showValidation").replaceWith("<div id='showValidation' class='alert alert-danger'> Please choose a show </div>");
    		} else {
    			$("#showValidation").replaceWith("<div id='showValidation'></div>");
    		}

    		if (!venueVal) {
    			$("#venueValidation").replaceWith("<div id='venueValidation' class='alert alert-danger'> Please enter a venue </div>");
    		} else {
    			$("#venueValidation").replaceWith("<div id='venueValidation'></div>");
    		}

   			if (!email) {
   				$("#emailValidation").replaceWith("<div id='emailValidation' class='alert alert-danger'> Please enter an email </div>");
   			} else {
   				$("#emailValidation").replaceWith("<div id='emailValidation'></div>");
   			}

   			if (!phoneNumber) {
   				$("#phoneNumberValidation").replaceWith("<div id='phoneNumberValidation' class='alert alert-danger'> Please enter a phone number </div>");
   			} else {
   				$("#phoneNumberValidation").replaceWith("<div id='phoneNumberValidation'></div>");
   			}

    		if (dateCount <= 1) {
    			$("#dateValidation").replaceWith("<div id='dateValidation' class='alert alert-danger'> Please pick a date </div>");
    		} else {
    			$("#dateValidation").replaceWith("<div id='dateValidation'></div>");
    		}

    	} else {
	    	var data = {};
    		var contactVal = [email, phoneNumber];
    		var showId = document.getElementsByName(showVal)[0].getAttribute("data-id");

    		data['show_id'] = showId;
    		data['venue'] = venueVal;
    		data['contact'] = contactVal;
    		data['notes'] = $("#notes").val();
    		data['date'] = [];

    		var dates = [];
	    	$('#auditionsTable > tbody  > tr').each(function() {
    			var isoDate = ($(this).data("date")).toISOString();
    			dates.push(isoDate);
	    	});

	    	data['date'] = dates;

			// $.each(data, function( key, value ) {
			//   alert( key + ": " + value );
			// });

			$.post('/auditions/addaudition', data, function(result) {
				if (result) {
					var auditionId = result.id;
					window.location.href = '/auditions/' + auditionId;
				};
    	    });

    	}
    });
});	
</script>

</body>
</html>
